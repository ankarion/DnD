---
type: character
tags:
  - character
character: "[[Гаретт]]"
image: "[[Гарретт.png]]"
---

```dataviewjs
let lvlUpRules = [200, 400, 700, 1000, 1300, 1800, 2300, 2800, 3500, 4200, 4900, 5600, 6500, 7400, 8300, 9200, 10300, 11400, 12500, 13600];

function calculateLvL(lvlUpRules, exp) {
    let lvl = 1;
    for (let requiredExp of lvlUpRules) {
        if (exp < requiredExp) {
            return lvl;
        } else {
            lvl += 1;
        }
    }
    return lvl;
}

function flatten(list) {
    let result = [];
    for (let element of list) {
        if (typeof(element) != typeof(result)) {
            result.push(element);
        } else {
            result.push(...element);
        }
    }
    return result;
}

// Получаем все записи для текущего персонажа
let adventures = dv.pages().where(
    note => note.file.frontmatter.type == "JournalEntry" && note.file.frontmatter.character == dv.current().file.frontmatter.character
);

// Собираем все награды
let rewards = flatten(adventures.rewards).filter(r => r);

// --- Обработка опыта, золота и еды ---
let exp = rewards
    .filter(t => t.toString().includes("оп"))
    .map(t => {
        let match = t.toString().match(/([-+]?\d+)оп/);
        return match ? parseInt(match[1]) : 0;
    })
    .reduce((acc, val) => acc + val, 0);

let lvl = calculateLvL(lvlUpRules, exp);

let gp = rewards
    .filter(t => t.toString().includes("зм"))
    .map(t => {
        let match = t.toString().match(/([-+]?\d+)зм/);
        return match ? parseInt(match[1]) : 0;
    })
    .reduce((acc, val) => acc + val, 0);

let food = rewards
    .filter(t => t.toString().includes("сухпай"))
    .map(t => {
        let match = t.toString().match(/([-+]?\d+)сухпай/);
        return match ? parseInt(match[1]) : 0;
    })
    .reduce((acc, val) => acc + val, 0);

// --- Обработка инвентаря ---
let inventory = {};

rewards.forEach(reward => {
    let rewardStr = reward.toString();
    
    // Вариант 1: Ищем шаблон типа "+10 [[Яблоко]]" или "-1 [[Зелье лечения]]"
    let matchWithQuantity = rewardStr.match(/([-+])?(\d+)\s*\[\[([^\]]+)\]\]/);
    
    if (matchWithQuantity) {
        let sign = matchWithQuantity[1] || '+';
        let quantity = parseInt(matchWithQuantity[2]);
        let itemName = matchWithQuantity[3];
        
        if (sign === '-') {
            quantity = -quantity;
        }
        
        if (!inventory[itemName]) {
            inventory[itemName] = 0;
        }
        inventory[itemName] += quantity;
    }
    // Вариант 2: Ищем шаблон типа "+[[ПоясИзЧешуиДракона]]" (без количества, подразумевается 1)
    else {
        let matchWithoutQuantity = rewardStr.match(/([-+]?)\[\[([^\]]+)\]\]/);
        
        if (matchWithoutQuantity) {
            let sign = matchWithoutQuantity[1] || '+';
            let itemName = matchWithoutQuantity[2];
            let quantity = 1;
            
            if (sign === '-') {
                quantity = -1;
            }
            
            if (!inventory[itemName]) {
                inventory[itemName] = 0;
            }
            inventory[itemName] += quantity;
        }
    }
});

// --- Отображение результата ---
dv.paragraph("![[_Персонажи.base#PersonalView]]");
dv.span(`**Уровень:** ${lvl} (${exp}/${lvlUpRules[lvl-1]}) `);
dv.paragraph(`**Золото:** ${gp} зм`);
dv.paragraph(`**Еда:** ${food} сухпай`);

// Отображаем инвентарь, если он не пустой
let inventoryItems = Object.entries(inventory);
if (inventoryItems.length > 0) {
    dv.header(3, "Инвентарь");
    
    // Создаем таблицу инвентаря с кликабельными ссылками
    dv.table(["Предмет", "Количество"],
        inventoryItems
            .filter(([item, qty]) => qty > 0)
            .map(([item, qty]) => [
                `[[${item}]]`,  // Это создаст кликабельную ссылку
                qty
            ])
    );
} else {
    dv.paragraph("_Инвентарь пуст_");
}
```

![[_Предметы.base#Inventory]]
